#! /bin/bash

fail()
{
    echo ERROR: "$@" >&2
    exit 1
}

trap fail ERR

# ----------------------------------------------------------------------

if [[ ! -d "${ACMACSD_ROOT}" || ! -d "${ACMACSD_ROOT}/sources/acmacs-api/settings" ]]; then
    fail "ACMACSD_ROOT not set or invalid"
fi

NOW=$(date "+%Y-%m%d-%H%M")
if [[ -d /syn/eu/acmacs-api-server ]]; then
    SERVER_ROOT=/syn/eu/acmacs-api-server
else
    SERVER_ROOT=.
fi
LOG_DIR="${SERVER_ROOT}/log"

if [[ "$(hostname)" == "i19" ]]; then
    pkill -f 'acmacs-api-server settings.json' || true
    for log in "${LOG_DIR}/"*.log; do
        bn=$(basename "${log}")
        /usr/bin/xz -9ec "${LOG_DIR}/${bn}" > "${LOG_DIR}/old/${NOW}.${bn}.xz"
        /bin/rm "${LOG_DIR}/${bn}"
    done
    echo "log files are in ${LOG_DIR}"
    echo "using settings from ${SERVER_ROOT}/settings.json"
    ${ACMACSD_ROOT}/bin/acmacs-api-server "${SERVER_ROOT}/settings.json" >"${LOG_DIR}/stdout.log" 2>"${LOG_DIR}/stderr.log" </dev/null &
else
    fail "Usupported host: $(hostname)"
fi
